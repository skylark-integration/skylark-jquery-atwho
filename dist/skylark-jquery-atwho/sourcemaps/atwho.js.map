{"version":3,"sources":["atwho.js"],"names":["define","$","DEFAULT_CALLBACKS","KEY_CODE","App","ESC","TAB","ENTER","CTRL","A","P","N","LEFT","UP","RIGHT","DOWN","BACKSPACE","SPACE","beforeSave","data","Controller","arrayToDefaultHash","matcher","flag","subtext","should_startWithSpace","acceptSpaceBar","_a","_y","match","replace","decodeURI","RegExp","exec","filter","query","searchKey","_results","i","item","len","length","String","toLowerCase","indexOf","push","remoteFilter","sorter","items","atwho_order","sort","a","b","tplEval","tpl","map","error1","template","tag","key","pos","highlighter","li","regexp","str","$1","$2","$3","beforeInsert","value","$li","e","beforeReposition","offset","afterMatchFailed","at","el","inputor","this","currentFlag","controllers","aliasMaps","$inputor","setupRootElement","listen","prototype","createContainer","doc","ref","$el","remove","body","append","iframe","asRoot","error","window","contentWindow","document","contentDocument","ownerDocument","defaultView","parentWindow","frameElement","fn","atwho","debug","Error","iframeAsRoot","controller","c","current","setContextFor","reg","setting","base","is","EditableController","TextareaController","alias","init","on","_this","view","hide","isComposing","setTimeout","dispatch","onKeyup","onKeydown","expectedQueryCBId","getOpt","lastScrollTop","scrollTop","currentScrollTop","target","shutdown","_","destroy","off","results","lookUp","keyCode","preventDefault","noop","ctrlKey","visible","prev","next","highlighted","choose","slice","app","at1","id","uid","range","model","Model","View","Math","random","toString","substr","Date","getTime","extend","reload","trigger","callDefault","args","funcName","arguments","call","apply","name","eventName","callbacks","default_value","insertContentFor","atwho-at","renderView","text","render","isArray","isPlainObject","wait","type","catchQuery","_delayLookUp","_lookUp","now","remaining","previousCallTime","_stopDelayedCall","delayedCallTimeout","clearTimeout","_generateQueryCBId","_callback","queryCBId","constructor","proxy","child","parent","hasProp","ctor","__super__","hasOwnProperty","superClass","caretPos","content","end","isString","start","val","caret","headPos","endPos","rect","iframeOffset","scaleBottom","left","top","selection","bottom","height","insert","source","startStr","suffix","max","focus","change","Api","_getRange","sel","getSelection","rangeCount","getRangeAt","_setRange","position","node","setEndAfter","setStartAfter","setEndBefore","setStartBefore","collapse","_clearRange","ctrl_a_pressed","removeAllRanges","addRange","_movingEvent","which","_unwrap","unwrap","get","nextSibling","nodeValue","$inserted","$query","_range","index","inserted","lastNode","matched","query_content","collapsed","startContainer","closest","contents","last","test","navigator","userAgent","nodeType","ELEMENT_NODE","startOffset","cloneRange","setStart","cloneContents","TEXT_NODE","previousSibling","addClass","siblings","removeClass","attr","empty","html","surroundContents","setEnd","hasClass","first","getClientRects","scrollLeft","overrides","suffixNode","insertNode","createTextNode","context","storage","saved","fetch","callback","_remoteFilter","save","load","_load","ajax","dataType","done","$elUl","children","timeoutID","bindEvent","header_tpl","charCodeAt","prepend","$menu","lastCoordX","lastCoordY","find","$cur","clientX","clientY","currentTarget","expr","filters","stopShowing","reposition","_window","overflowOffset","width","nextEl","offsetTop","offsetHeight","prevEl","scrollDuration","animate","show","time","isNaN","list","$ul","isSelecting","setIframe","run","method","_args","result","each","$this","Array","displayTpl","insertTpl","headerTpl","functionOverrides","hideWithoutSuffix","startWithSpace","highlightFirst","limit","maxLen","minLen","displayTimeout","delay","spaceSelectsMatch","tabSelectsMatch","editableAtwhoQueryAttrs","suspendOnComposing","lookUpOnClick"],"mappings":"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","file":"../atwho.js","sourcesContent":["define([\n  \"skylark-jquery\"\n],function ($) {\nvar DEFAULT_CALLBACKS, KEY_CODE;\n\nKEY_CODE = {\n  ESC: 27,\n  TAB: 9,\n  ENTER: 13,\n  CTRL: 17,\n  A: 65,\n  P: 80,\n  N: 78,\n  LEFT: 37,\n  UP: 38,\n  RIGHT: 39,\n  DOWN: 40,\n  BACKSPACE: 8,\n  SPACE: 32\n};\n\nDEFAULT_CALLBACKS = {\n  beforeSave: function(data) {\n    return Controller.arrayToDefaultHash(data);\n  },\n  matcher: function(flag, subtext, should_startWithSpace, acceptSpaceBar) {\n    var _a, _y, match, regexp, space;\n    flag = flag.replace(/[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]/g, \"\\\\$&\");\n    if (should_startWithSpace) {\n      flag = '(?:^|\\\\s)' + flag;\n    }\n    _a = decodeURI(\"%C3%80\");\n    _y = decodeURI(\"%C3%BF\");\n    space = acceptSpaceBar ? \"\\ \" : \"\";\n    regexp = new RegExp(flag + \"([A-Za-z\" + _a + \"-\" + _y + \"0-9_\" + space + \"\\'\\.\\+\\-]*)$|\" + flag + \"([^\\\\x00-\\\\xff]*)$\", 'gi');\n    match = regexp.exec(subtext);\n    if (match) {\n      return match[2] || match[1];\n    } else {\n      return null;\n    }\n  },\n  filter: function(query, data, searchKey) {\n    var _results, i, item, len;\n    _results = [];\n    for (i = 0, len = data.length; i < len; i++) {\n      item = data[i];\n      if (~new String(item[searchKey]).toLowerCase().indexOf(query.toLowerCase())) {\n        _results.push(item);\n      }\n    }\n    return _results;\n  },\n  remoteFilter: null,\n  sorter: function(query, items, searchKey) {\n    var _results, i, item, len;\n    if (!query) {\n      return items;\n    }\n    _results = [];\n    for (i = 0, len = items.length; i < len; i++) {\n      item = items[i];\n      item.atwho_order = new String(item[searchKey]).toLowerCase().indexOf(query.toLowerCase());\n      if (item.atwho_order > -1) {\n        _results.push(item);\n      }\n    }\n    return _results.sort(function(a, b) {\n      return a.atwho_order - b.atwho_order;\n    });\n  },\n  tplEval: function(tpl, map) {\n    var error, error1, template;\n    template = tpl;\n    try {\n      if (typeof tpl !== 'string') {\n        template = tpl(map);\n      }\n      return template.replace(/\\$\\{([^\\}]*)\\}/g, function(tag, key, pos) {\n        return map[key];\n      });\n    } catch (error1) {\n      error = error1;\n      return \"\";\n    }\n  },\n  highlighter: function(li, query) {\n    var regexp;\n    if (!query) {\n      return li;\n    }\n    regexp = new RegExp(\">\\\\s*([^\\<]*?)(\" + query.replace(\"+\", \"\\\\+\") + \")([^\\<]*)\\\\s*<\", 'ig');\n    return li.replace(regexp, function(str, $1, $2, $3) {\n      return '> ' + $1 + '<strong>' + $2 + '</strong>' + $3 + ' <';\n    });\n  },\n  beforeInsert: function(value, $li, e) {\n    return value;\n  },\n  beforeReposition: function(offset) {\n    return offset;\n  },\n  afterMatchFailed: function(at, el) {}\n};\n\nvar App;\n\nApp = (function() {\n  function App(inputor) {\n    this.currentFlag = null;\n    this.controllers = {};\n    this.aliasMaps = {};\n    this.$inputor = $(inputor);\n    this.setupRootElement();\n    this.listen();\n  }\n\n  App.prototype.createContainer = function(doc) {\n    var ref;\n    if ((ref = this.$el) != null) {\n      ref.remove();\n    }\n    return $(doc.body).append(this.$el = $(\"<div class='atwho-container'></div>\"));\n  };\n\n  App.prototype.setupRootElement = function(iframe, asRoot) {\n    var error, error1;\n    if (asRoot == null) {\n      asRoot = false;\n    }\n    if (iframe) {\n      this.window = iframe.contentWindow;\n      this.document = iframe.contentDocument || this.window.document;\n      this.iframe = iframe;\n    } else {\n      this.document = this.$inputor[0].ownerDocument;\n      this.window = this.document.defaultView || this.document.parentWindow;\n      try {\n        this.iframe = this.window.frameElement;\n      } catch (error1) {\n        error = error1;\n        this.iframe = null;\n        if ($.fn.atwho.debug) {\n          throw new Error(\"iframe auto-discovery is failed.\\nPlease use `setIframe` to set the target iframe manually.\\n\" + error);\n        }\n      }\n    }\n    return this.createContainer((this.iframeAsRoot = asRoot) ? this.document : document);\n  };\n\n  App.prototype.controller = function(at) {\n    var c, current, currentFlag, ref;\n    if (this.aliasMaps[at]) {\n      current = this.controllers[this.aliasMaps[at]];\n    } else {\n      ref = this.controllers;\n      for (currentFlag in ref) {\n        c = ref[currentFlag];\n        if (currentFlag === at) {\n          current = c;\n          break;\n        }\n      }\n    }\n    if (current) {\n      return current;\n    } else {\n      return this.controllers[this.currentFlag];\n    }\n  };\n\n  App.prototype.setContextFor = function(at) {\n    this.currentFlag = at;\n    return this;\n  };\n\n  App.prototype.reg = function(flag, setting) {\n    var base, controller;\n    controller = (base = this.controllers)[flag] || (base[flag] = this.$inputor.is('[contentEditable]') ? new EditableController(this, flag) : new TextareaController(this, flag));\n    if (setting.alias) {\n      this.aliasMaps[setting.alias] = flag;\n    }\n    controller.init(setting);\n    return this;\n  };\n\n  App.prototype.listen = function() {\n    return this.$inputor.on('compositionstart', (function(_this) {\n      return function(e) {\n        var ref;\n        if ((ref = _this.controller()) != null) {\n          ref.view.hide();\n        }\n        _this.isComposing = true;\n        return null;\n      };\n    })(this)).on('compositionend', (function(_this) {\n      return function(e) {\n        _this.isComposing = false;\n        setTimeout(function(e) {\n          return _this.dispatch(e);\n        });\n        return null;\n      };\n    })(this)).on('keyup.atwhoInner', (function(_this) {\n      return function(e) {\n        return _this.onKeyup(e);\n      };\n    })(this)).on('keydown.atwhoInner', (function(_this) {\n      return function(e) {\n        return _this.onKeydown(e);\n      };\n    })(this)).on('blur.atwhoInner', (function(_this) {\n      return function(e) {\n        var c;\n        if (c = _this.controller()) {\n          c.expectedQueryCBId = null;\n          return c.view.hide(e, c.getOpt(\"displayTimeout\"));\n        }\n      };\n    })(this)).on('click.atwhoInner', (function(_this) {\n      return function(e) {\n        return _this.dispatch(e);\n      };\n    })(this)).on('scroll.atwhoInner', (function(_this) {\n      return function() {\n        var lastScrollTop;\n        lastScrollTop = _this.$inputor.scrollTop();\n        return function(e) {\n          var currentScrollTop, ref;\n          currentScrollTop = e.target.scrollTop;\n          if (lastScrollTop !== currentScrollTop) {\n            if ((ref = _this.controller()) != null) {\n              ref.view.hide(e);\n            }\n          }\n          lastScrollTop = currentScrollTop;\n          return true;\n        };\n      };\n    })(this)());\n  };\n\n  App.prototype.shutdown = function() {\n    var _, c, ref;\n    ref = this.controllers;\n    for (_ in ref) {\n      c = ref[_];\n      c.destroy();\n      delete this.controllers[_];\n    }\n    this.$inputor.off('.atwhoInner');\n    return this.$el.remove();\n  };\n\n  App.prototype.dispatch = function(e) {\n    var _, c, ref, results;\n    ref = this.controllers;\n    results = [];\n    for (_ in ref) {\n      c = ref[_];\n      results.push(c.lookUp(e));\n    }\n    return results;\n  };\n\n  App.prototype.onKeyup = function(e) {\n    var ref;\n    switch (e.keyCode) {\n      case KEY_CODE.ESC:\n        e.preventDefault();\n        if ((ref = this.controller()) != null) {\n          ref.view.hide();\n        }\n        break;\n      case KEY_CODE.DOWN:\n      case KEY_CODE.UP:\n      case KEY_CODE.CTRL:\n      case KEY_CODE.ENTER:\n        $.noop();\n        break;\n      case KEY_CODE.P:\n      case KEY_CODE.N:\n        if (!e.ctrlKey) {\n          this.dispatch(e);\n        }\n        break;\n      default:\n        this.dispatch(e);\n    }\n  };\n\n  App.prototype.onKeydown = function(e) {\n    var ref, view;\n    view = (ref = this.controller()) != null ? ref.view : void 0;\n    if (!(view && view.visible())) {\n      return;\n    }\n    switch (e.keyCode) {\n      case KEY_CODE.ESC:\n        e.preventDefault();\n        view.hide(e);\n        break;\n      case KEY_CODE.UP:\n        e.preventDefault();\n        view.prev();\n        break;\n      case KEY_CODE.DOWN:\n        e.preventDefault();\n        view.next();\n        break;\n      case KEY_CODE.P:\n        if (!e.ctrlKey) {\n          return;\n        }\n        e.preventDefault();\n        view.prev();\n        break;\n      case KEY_CODE.N:\n        if (!e.ctrlKey) {\n          return;\n        }\n        e.preventDefault();\n        view.next();\n        break;\n      case KEY_CODE.TAB:\n      case KEY_CODE.ENTER:\n      case KEY_CODE.SPACE:\n        if (!view.visible()) {\n          return;\n        }\n        if (!this.controller().getOpt('spaceSelectsMatch') && e.keyCode === KEY_CODE.SPACE) {\n          return;\n        }\n        if (!this.controller().getOpt('tabSelectsMatch') && e.keyCode === KEY_CODE.TAB) {\n          return;\n        }\n        if (view.highlighted()) {\n          e.preventDefault();\n          view.choose(e);\n        } else {\n          view.hide(e);\n        }\n        break;\n      default:\n        $.noop();\n    }\n  };\n\n  return App;\n\n})();\n\nvar Controller,\n  slice = [].slice;\n\nController = (function() {\n  Controller.prototype.uid = function() {\n    return (Math.random().toString(16) + \"000000000\").substr(2, 8) + (new Date().getTime());\n  };\n\n  function Controller(app, at1) {\n    this.app = app;\n    this.at = at1;\n    this.$inputor = this.app.$inputor;\n    this.id = this.$inputor[0].id || this.uid();\n    this.expectedQueryCBId = null;\n    this.setting = null;\n    this.query = null;\n    this.pos = 0;\n    this.range = null;\n    if ((this.$el = $(\"#atwho-ground-\" + this.id, this.app.$el)).length === 0) {\n      this.app.$el.append(this.$el = $(\"<div id='atwho-ground-\" + this.id + \"'></div>\"));\n    }\n    this.model = new Model(this);\n    this.view = new View(this);\n  }\n\n  Controller.prototype.init = function(setting) {\n    this.setting = $.extend({}, this.setting || $.fn.atwho[\"default\"], setting);\n    this.view.init();\n    return this.model.reload(this.setting.data);\n  };\n\n  Controller.prototype.destroy = function() {\n    this.trigger('beforeDestroy');\n    this.model.destroy();\n    this.view.destroy();\n    return this.$el.remove();\n  };\n\n  Controller.prototype.callDefault = function() {\n    var args, error, error1, funcName;\n    funcName = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];\n    try {\n      return DEFAULT_CALLBACKS[funcName].apply(this, args);\n    } catch (error1) {\n      error = error1;\n      return $.error(error + \" Or maybe At.js doesn't have function \" + funcName);\n    }\n  };\n\n  Controller.prototype.trigger = function(name, data) {\n    var alias, eventName;\n    if (data == null) {\n      data = [];\n    }\n    data.push(this);\n    alias = this.getOpt('alias');\n    eventName = alias ? name + \"-\" + alias + \".atwho\" : name + \".atwho\";\n    return this.$inputor.trigger(eventName, data);\n  };\n\n  Controller.prototype.callbacks = function(funcName) {\n    return this.getOpt(\"callbacks\")[funcName] || DEFAULT_CALLBACKS[funcName];\n  };\n\n  Controller.prototype.getOpt = function(at, default_value) {\n    var e, error1;\n    try {\n      return this.setting[at];\n    } catch (error1) {\n      e = error1;\n      return null;\n    }\n  };\n\n  Controller.prototype.insertContentFor = function($li) {\n    var data, tpl;\n    tpl = this.getOpt('insertTpl');\n    data = $.extend({}, $li.data('item-data'), {\n      'atwho-at': this.at\n    });\n    return this.callbacks(\"tplEval\").call(this, tpl, data, \"onInsert\");\n  };\n\n  Controller.prototype.renderView = function(data) {\n    var searchKey;\n    searchKey = this.getOpt(\"searchKey\");\n    data = this.callbacks(\"sorter\").call(this, this.query.text, data.slice(0, 1001), searchKey);\n    return this.view.render(data.slice(0, this.getOpt('limit')));\n  };\n\n  Controller.arrayToDefaultHash = function(data) {\n    var i, item, len, results;\n    if (!$.isArray(data)) {\n      return data;\n    }\n    results = [];\n    for (i = 0, len = data.length; i < len; i++) {\n      item = data[i];\n      if ($.isPlainObject(item)) {\n        results.push(item);\n      } else {\n        results.push({\n          name: item\n        });\n      }\n    }\n    return results;\n  };\n\n  Controller.prototype.lookUp = function(e) {\n    var query, wait;\n    if (e && e.type === 'click' && !this.getOpt('lookUpOnClick')) {\n      return;\n    }\n    if (this.getOpt('suspendOnComposing') && this.app.isComposing) {\n      return;\n    }\n    query = this.catchQuery(e);\n    if (!query) {\n      this.expectedQueryCBId = null;\n      return query;\n    }\n    this.app.setContextFor(this.at);\n    if (wait = this.getOpt('delay')) {\n      this._delayLookUp(query, wait);\n    } else {\n      this._lookUp(query);\n    }\n    return query;\n  };\n\n  Controller.prototype._delayLookUp = function(query, wait) {\n    var now, remaining;\n    now = Date.now ? Date.now() : new Date().getTime();\n    this.previousCallTime || (this.previousCallTime = now);\n    remaining = wait - (now - this.previousCallTime);\n    if ((0 < remaining && remaining < wait)) {\n      this.previousCallTime = now;\n      this._stopDelayedCall();\n      return this.delayedCallTimeout = setTimeout((function(_this) {\n        return function() {\n          _this.previousCallTime = 0;\n          _this.delayedCallTimeout = null;\n          return _this._lookUp(query);\n        };\n      })(this), wait);\n    } else {\n      this._stopDelayedCall();\n      if (this.previousCallTime !== now) {\n        this.previousCallTime = 0;\n      }\n      return this._lookUp(query);\n    }\n  };\n\n  Controller.prototype._stopDelayedCall = function() {\n    if (this.delayedCallTimeout) {\n      clearTimeout(this.delayedCallTimeout);\n      return this.delayedCallTimeout = null;\n    }\n  };\n\n  Controller.prototype._generateQueryCBId = function() {\n    return {};\n  };\n\n  Controller.prototype._lookUp = function(query) {\n    var _callback;\n    _callback = function(queryCBId, data) {\n      if (queryCBId !== this.expectedQueryCBId) {\n        return;\n      }\n      if (data && data.length > 0) {\n        return this.renderView(this.constructor.arrayToDefaultHash(data));\n      } else {\n        return this.view.hide();\n      }\n    };\n    this.expectedQueryCBId = this._generateQueryCBId();\n    return this.model.query(query.text, $.proxy(_callback, this, this.expectedQueryCBId));\n  };\n\n  return Controller;\n\n})();\n\nvar TextareaController,\n  extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },\n  hasProp = {}.hasOwnProperty;\n\nTextareaController = (function(superClass) {\n  extend(TextareaController, superClass);\n\n  function TextareaController() {\n    return TextareaController.__super__.constructor.apply(this, arguments);\n  }\n\n  TextareaController.prototype.catchQuery = function() {\n    var caretPos, content, end, isString, query, start, subtext;\n    content = this.$inputor.val();\n    caretPos = this.$inputor.caret('pos', {\n      iframe: this.app.iframe\n    });\n    subtext = content.slice(0, caretPos);\n    query = this.callbacks(\"matcher\").call(this, this.at, subtext, this.getOpt('startWithSpace'), this.getOpt(\"acceptSpaceBar\"));\n    isString = typeof query === 'string';\n    if (isString && query.length < this.getOpt('minLen', 0)) {\n      return;\n    }\n    if (isString && query.length <= this.getOpt('maxLen', 20)) {\n      start = caretPos - query.length;\n      end = start + query.length;\n      this.pos = start;\n      query = {\n        'text': query,\n        'headPos': start,\n        'endPos': end\n      };\n      this.trigger(\"matched\", [this.at, query.text]);\n    } else {\n      query = null;\n      this.view.hide();\n    }\n    return this.query = query;\n  };\n\n  TextareaController.prototype.rect = function() {\n    var c, iframeOffset, scaleBottom;\n    if (!(c = this.$inputor.caret('offset', this.pos - 1, {\n      iframe: this.app.iframe\n    }))) {\n      return;\n    }\n    if (this.app.iframe && !this.app.iframeAsRoot) {\n      iframeOffset = $(this.app.iframe).offset();\n      c.left += iframeOffset.left;\n      c.top += iframeOffset.top;\n    }\n    scaleBottom = this.app.document.selection ? 0 : 2;\n    return {\n      left: c.left,\n      top: c.top,\n      bottom: c.top + c.height + scaleBottom\n    };\n  };\n\n  TextareaController.prototype.insert = function(content, $li) {\n    var $inputor, source, startStr, suffix, text;\n    $inputor = this.$inputor;\n    source = $inputor.val();\n    startStr = source.slice(0, Math.max(this.query.headPos - this.at.length, 0));\n    suffix = (suffix = this.getOpt('suffix')) === \"\" ? suffix : suffix || \" \";\n    content += suffix;\n    text = \"\" + startStr + content + (source.slice(this.query['endPos'] || 0));\n    $inputor.val(text);\n    $inputor.caret('pos', startStr.length + content.length, {\n      iframe: this.app.iframe\n    });\n    if (!$inputor.is(':focus')) {\n      $inputor.focus();\n    }\n    return $inputor.change();\n  };\n\n  return TextareaController;\n\n})(Controller);\n\nvar EditableController,\n  extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },\n  hasProp = {}.hasOwnProperty;\n\nEditableController = (function(superClass) {\n  extend(EditableController, superClass);\n\n  function EditableController() {\n    return EditableController.__super__.constructor.apply(this, arguments);\n  }\n\n  EditableController.prototype._getRange = function() {\n    var sel;\n    sel = this.app.window.getSelection();\n    if (sel.rangeCount > 0) {\n      return sel.getRangeAt(0);\n    }\n  };\n\n  EditableController.prototype._setRange = function(position, node, range) {\n    if (range == null) {\n      range = this._getRange();\n    }\n    if (!(range && node)) {\n      return;\n    }\n    node = $(node)[0];\n    if (position === 'after') {\n      range.setEndAfter(node);\n      range.setStartAfter(node);\n    } else {\n      range.setEndBefore(node);\n      range.setStartBefore(node);\n    }\n    range.collapse(false);\n    return this._clearRange(range);\n  };\n\n  EditableController.prototype._clearRange = function(range) {\n    var sel;\n    if (range == null) {\n      range = this._getRange();\n    }\n    sel = this.app.window.getSelection();\n    if (this.ctrl_a_pressed == null) {\n      sel.removeAllRanges();\n      return sel.addRange(range);\n    }\n  };\n\n  EditableController.prototype._movingEvent = function(e) {\n    var ref;\n    return e.type === 'click' || ((ref = e.which) === KEY_CODE.RIGHT || ref === KEY_CODE.LEFT || ref === KEY_CODE.UP || ref === KEY_CODE.DOWN);\n  };\n\n  EditableController.prototype._unwrap = function(node) {\n    var next;\n    node = $(node).unwrap().get(0);\n    if ((next = node.nextSibling) && next.nodeValue) {\n      node.nodeValue += next.nodeValue;\n      $(next).remove();\n    }\n    return node;\n  };\n\n  EditableController.prototype.catchQuery = function(e) {\n    var $inserted, $query, _range, index, inserted, isString, lastNode, matched, offset, query, query_content, range;\n    if (!(range = this._getRange())) {\n      return;\n    }\n    if (!range.collapsed) {\n      return;\n    }\n    if (e.which === KEY_CODE.ENTER) {\n      ($query = $(range.startContainer).closest('.atwho-query')).contents().unwrap();\n      if ($query.is(':empty')) {\n        $query.remove();\n      }\n      ($query = $(\".atwho-query\", this.app.document)).text($query.text()).contents().last().unwrap();\n      this._clearRange();\n      return;\n    }\n    if (/firefox/i.test(navigator.userAgent)) {\n      if ($(range.startContainer).is(this.$inputor)) {\n        this._clearRange();\n        return;\n      }\n      if (e.which === KEY_CODE.BACKSPACE && range.startContainer.nodeType === document.ELEMENT_NODE && (offset = range.startOffset - 1) >= 0) {\n        _range = range.cloneRange();\n        _range.setStart(range.startContainer, offset);\n        if ($(_range.cloneContents()).contents().last().is('.atwho-inserted')) {\n          inserted = $(range.startContainer).contents().get(offset);\n          this._setRange('after', $(inserted).contents().last());\n        }\n      } else if (e.which === KEY_CODE.LEFT && range.startContainer.nodeType === document.TEXT_NODE) {\n        $inserted = $(range.startContainer.previousSibling);\n        if ($inserted.is('.atwho-inserted') && range.startOffset === 0) {\n          this._setRange('after', $inserted.contents().last());\n        }\n      }\n    }\n    $(range.startContainer).closest('.atwho-inserted').addClass('atwho-query').siblings().removeClass('atwho-query');\n    if (($query = $(\".atwho-query\", this.app.document)).length > 0 && $query.is(':empty') && $query.text().length === 0) {\n      $query.remove();\n    }\n    if (!this._movingEvent(e)) {\n      $query.removeClass('atwho-inserted');\n    }\n    if ($query.length > 0) {\n      switch (e.which) {\n        case KEY_CODE.LEFT:\n          this._setRange('before', $query.get(0), range);\n          $query.removeClass('atwho-query');\n          return;\n        case KEY_CODE.RIGHT:\n          this._setRange('after', $query.get(0).nextSibling, range);\n          $query.removeClass('atwho-query');\n          return;\n      }\n    }\n    if ($query.length > 0 && (query_content = $query.attr('data-atwho-at-query'))) {\n      $query.empty().html(query_content).attr('data-atwho-at-query', null);\n      this._setRange('after', $query.get(0), range);\n    }\n    _range = range.cloneRange();\n    _range.setStart(range.startContainer, 0);\n    matched = this.callbacks(\"matcher\").call(this, this.at, _range.toString(), this.getOpt('startWithSpace'), this.getOpt(\"acceptSpaceBar\"));\n    isString = typeof matched === 'string';\n    if ($query.length === 0 && isString && (index = range.startOffset - this.at.length - matched.length) >= 0) {\n      range.setStart(range.startContainer, index);\n      $query = $('<span/>', this.app.document).attr(this.getOpt(\"editableAtwhoQueryAttrs\")).addClass('atwho-query');\n      range.surroundContents($query.get(0));\n      lastNode = $query.contents().last().get(0);\n      if (lastNode) {\n        if (/firefox/i.test(navigator.userAgent)) {\n          range.setStart(lastNode, lastNode.length);\n          range.setEnd(lastNode, lastNode.length);\n          this._clearRange(range);\n        } else {\n          this._setRange('after', lastNode, range);\n        }\n      }\n    }\n    if (isString && matched.length < this.getOpt('minLen', 0)) {\n      return;\n    }\n    if (isString && matched.length <= this.getOpt('maxLen', 20)) {\n      query = {\n        text: matched,\n        el: $query\n      };\n      this.trigger(\"matched\", [this.at, query.text]);\n      return this.query = query;\n    } else {\n      this.view.hide();\n      this.query = {\n        el: $query\n      };\n      if ($query.text().indexOf(this.at) >= 0) {\n        if (this._movingEvent(e) && $query.hasClass('atwho-inserted')) {\n          $query.removeClass('atwho-query');\n        } else if (false !== this.callbacks('afterMatchFailed').call(this, this.at, $query)) {\n          this._setRange(\"after\", this._unwrap($query.text($query.text()).contents().first()));\n        }\n      }\n      return null;\n    }\n  };\n\n  EditableController.prototype.rect = function() {\n    var $iframe, iframeOffset, rect;\n    rect = this.query.el.offset();\n    if (!(rect && this.query.el[0].getClientRects().length)) {\n      return;\n    }\n    if (this.app.iframe && !this.app.iframeAsRoot) {\n      iframeOffset = ($iframe = $(this.app.iframe)).offset();\n      rect.left += iframeOffset.left - this.$inputor.scrollLeft();\n      rect.top += iframeOffset.top - this.$inputor.scrollTop();\n    }\n    rect.bottom = rect.top + this.query.el.height();\n    return rect;\n  };\n\n  EditableController.prototype.insert = function(content, $li) {\n    var data, overrides, range, suffix, suffixNode;\n    if (!this.$inputor.is(':focus')) {\n      this.$inputor.focus();\n    }\n    overrides = this.getOpt('functionOverrides');\n    if (overrides.insert) {\n      return overrides.insert.call(this, content, $li);\n    }\n    suffix = (suffix = this.getOpt('suffix')) === \"\" ? suffix : suffix || \"\\u00A0\";\n    data = $li.data('item-data');\n    this.query.el.removeClass('atwho-query').addClass('atwho-inserted').html(content).attr('data-atwho-at-query', \"\" + data['atwho-at'] + this.query.text).attr('contenteditable', \"false\");\n    if (range = this._getRange()) {\n      if (this.query.el.length) {\n        range.setEndAfter(this.query.el[0]);\n      }\n      range.collapse(false);\n      range.insertNode(suffixNode = this.app.document.createTextNode(\"\" + suffix));\n      this._setRange('after', suffixNode, range);\n    }\n    if (!this.$inputor.is(':focus')) {\n      this.$inputor.focus();\n    }\n    return this.$inputor.change();\n  };\n\n  return EditableController;\n\n})(Controller);\n\nvar Model;\n\nModel = (function() {\n  function Model(context) {\n    this.context = context;\n    this.at = this.context.at;\n    this.storage = this.context.$inputor;\n  }\n\n  Model.prototype.destroy = function() {\n    return this.storage.data(this.at, null);\n  };\n\n  Model.prototype.saved = function() {\n    return this.fetch() > 0;\n  };\n\n  Model.prototype.query = function(query, callback) {\n    var _remoteFilter, data, searchKey;\n    data = this.fetch();\n    searchKey = this.context.getOpt(\"searchKey\");\n    data = this.context.callbacks('filter').call(this.context, query, data, searchKey) || [];\n    _remoteFilter = this.context.callbacks('remoteFilter');\n    if (data.length > 0 || (!_remoteFilter && data.length === 0)) {\n      return callback(data);\n    } else {\n      return _remoteFilter.call(this.context, query, callback);\n    }\n  };\n\n  Model.prototype.fetch = function() {\n    return this.storage.data(this.at) || [];\n  };\n\n  Model.prototype.save = function(data) {\n    return this.storage.data(this.at, this.context.callbacks(\"beforeSave\").call(this.context, data || []));\n  };\n\n  Model.prototype.load = function(data) {\n    if (!(this.saved() || !data)) {\n      return this._load(data);\n    }\n  };\n\n  Model.prototype.reload = function(data) {\n    return this._load(data);\n  };\n\n  Model.prototype._load = function(data) {\n    if (typeof data === \"string\") {\n      return $.ajax(data, {\n        dataType: \"json\"\n      }).done((function(_this) {\n        return function(data) {\n          return _this.save(data);\n        };\n      })(this));\n    } else {\n      return this.save(data);\n    }\n  };\n\n  return Model;\n\n})();\n\nvar View;\n\nView = (function() {\n  function View(context) {\n    this.context = context;\n    this.$el = $(\"<div class='atwho-view'><ul class='atwho-view-ul'></ul></div>\");\n    this.$elUl = this.$el.children();\n    this.timeoutID = null;\n    this.context.$el.append(this.$el);\n    this.bindEvent();\n  }\n\n  View.prototype.init = function() {\n    var header_tpl, id;\n    id = this.context.getOpt(\"alias\") || this.context.at.charCodeAt(0);\n    header_tpl = this.context.getOpt(\"headerTpl\");\n    if (header_tpl && this.$el.children().length === 1) {\n      this.$el.prepend(header_tpl);\n    }\n    return this.$el.attr({\n      'id': \"at-view-\" + id\n    });\n  };\n\n  View.prototype.destroy = function() {\n    return this.$el.remove();\n  };\n\n  View.prototype.bindEvent = function() {\n    var $menu, lastCoordX, lastCoordY;\n    $menu = this.$el.find('ul');\n    lastCoordX = 0;\n    lastCoordY = 0;\n    return $menu.on('mousemove.atwho-view', 'li', (function(_this) {\n      return function(e) {\n        var $cur;\n        if (lastCoordX === e.clientX && lastCoordY === e.clientY) {\n          return;\n        }\n        lastCoordX = e.clientX;\n        lastCoordY = e.clientY;\n        $cur = $(e.currentTarget);\n        if ($cur.hasClass('cur')) {\n          return;\n        }\n        $menu.find('.cur').removeClass('cur');\n        return $cur.addClass('cur');\n      };\n    })(this)).on('click.atwho-view', 'li', (function(_this) {\n      return function(e) {\n        $menu.find('.cur').removeClass('cur');\n        $(e.currentTarget).addClass('cur');\n        _this.choose(e);\n        return e.preventDefault();\n      };\n    })(this));\n  };\n\n  View.prototype.visible = function() {\n    return $.expr.filters.visible(this.$el[0]);\n  };\n\n  View.prototype.highlighted = function() {\n    return this.$el.find(\".cur\").length > 0;\n  };\n\n  View.prototype.choose = function(e) {\n    var $li, content;\n    if (($li = this.$el.find(\".cur\")).length) {\n      content = this.context.insertContentFor($li);\n      this.context._stopDelayedCall();\n      this.context.insert(this.context.callbacks(\"beforeInsert\").call(this.context, content, $li, e), $li);\n      this.context.trigger(\"inserted\", [$li, e]);\n      this.hide(e);\n    }\n    if (this.context.getOpt(\"hideWithoutSuffix\")) {\n      return this.stopShowing = true;\n    }\n  };\n\n  View.prototype.reposition = function(rect) {\n    var _window, offset, overflowOffset, ref;\n    _window = this.context.app.iframeAsRoot ? this.context.app.window : window;\n    if (rect.bottom + this.$el.height() - $(_window).scrollTop() > $(_window).height()) {\n      rect.bottom = rect.top - this.$el.height();\n    }\n    if (rect.left > (overflowOffset = $(_window).width() - this.$el.width() - 5)) {\n      rect.left = overflowOffset;\n    }\n    offset = {\n      left: rect.left,\n      top: rect.bottom\n    };\n    if ((ref = this.context.callbacks(\"beforeReposition\")) != null) {\n      ref.call(this.context, offset);\n    }\n    this.$el.offset(offset);\n    return this.context.trigger(\"reposition\", [offset]);\n  };\n\n  View.prototype.next = function() {\n    var cur, next, nextEl, offset;\n    cur = this.$el.find('.cur').removeClass('cur');\n    next = cur.next();\n    if (!next.length) {\n      next = this.$el.find('li:first');\n    }\n    next.addClass('cur');\n    nextEl = next[0];\n    offset = nextEl.offsetTop + nextEl.offsetHeight + (nextEl.nextSibling ? nextEl.nextSibling.offsetHeight : 0);\n    return this.scrollTop(Math.max(0, offset - this.$el.height()));\n  };\n\n  View.prototype.prev = function() {\n    var cur, offset, prev, prevEl;\n    cur = this.$el.find('.cur').removeClass('cur');\n    prev = cur.prev();\n    if (!prev.length) {\n      prev = this.$el.find('li:last');\n    }\n    prev.addClass('cur');\n    prevEl = prev[0];\n    offset = prevEl.offsetTop + prevEl.offsetHeight + (prevEl.nextSibling ? prevEl.nextSibling.offsetHeight : 0);\n    return this.scrollTop(Math.max(0, offset - this.$el.height()));\n  };\n\n  View.prototype.scrollTop = function(scrollTop) {\n    var scrollDuration;\n    scrollDuration = this.context.getOpt('scrollDuration');\n    if (scrollDuration) {\n      return this.$elUl.animate({\n        scrollTop: scrollTop\n      }, scrollDuration);\n    } else {\n      return this.$elUl.scrollTop(scrollTop);\n    }\n  };\n\n  View.prototype.show = function() {\n    var rect;\n    if (this.stopShowing) {\n      this.stopShowing = false;\n      return;\n    }\n    if (!this.visible()) {\n      this.$el.show();\n      this.$el.scrollTop(0);\n      this.context.trigger('shown');\n    }\n    if (rect = this.context.rect()) {\n      return this.reposition(rect);\n    }\n  };\n\n  View.prototype.hide = function(e, time) {\n    var callback;\n    if (!this.visible()) {\n      return;\n    }\n    if (isNaN(time)) {\n      this.$el.hide();\n      return this.context.trigger('hidden', [e]);\n    } else {\n      callback = (function(_this) {\n        return function() {\n          return _this.hide();\n        };\n      })(this);\n      clearTimeout(this.timeoutID);\n      return this.timeoutID = setTimeout(callback, time);\n    }\n  };\n\n  View.prototype.render = function(list) {\n    var $li, $ul, i, item, len, li, tpl;\n    if (!($.isArray(list) && list.length > 0)) {\n      this.hide();\n      return;\n    }\n    this.$el.find('ul').empty();\n    $ul = this.$el.find('ul');\n    tpl = this.context.getOpt('displayTpl');\n    for (i = 0, len = list.length; i < len; i++) {\n      item = list[i];\n      item = $.extend({}, item, {\n        'atwho-at': this.context.at\n      });\n      li = this.context.callbacks(\"tplEval\").call(this.context, tpl, item, \"onDisplay\");\n      $li = $(this.context.callbacks(\"highlighter\").call(this.context, li, this.context.query.text));\n      $li.data(\"item-data\", item);\n      $ul.append($li);\n    }\n    this.show();\n    if (this.context.getOpt('highlightFirst')) {\n      return $ul.find(\"li:first\").addClass(\"cur\");\n    }\n  };\n\n  return View;\n\n})();\n\nvar Api;\n\nApi = {\n  load: function(at, data) {\n    var c;\n    if (c = this.controller(at)) {\n      return c.model.load(data);\n    }\n  },\n  isSelecting: function() {\n    var ref;\n    return !!((ref = this.controller()) != null ? ref.view.visible() : void 0);\n  },\n  hide: function() {\n    var ref;\n    return (ref = this.controller()) != null ? ref.view.hide() : void 0;\n  },\n  reposition: function() {\n    var c;\n    if (c = this.controller()) {\n      return c.view.reposition(c.rect());\n    }\n  },\n  setIframe: function(iframe, asRoot) {\n    this.setupRootElement(iframe, asRoot);\n    return null;\n  },\n  run: function() {\n    return this.dispatch();\n  },\n  destroy: function() {\n    this.shutdown();\n    return this.$inputor.data('atwho', null);\n  }\n};\n\n$.fn.atwho = function(method) {\n  var _args, result;\n  _args = arguments;\n  result = null;\n  this.filter('textarea, input, [contenteditable=\"\"], [contenteditable=true]').each(function() {\n    var $this, app;\n    if (!(app = ($this = $(this)).data(\"atwho\"))) {\n      $this.data('atwho', (app = new App(this)));\n    }\n    if (typeof method === 'object' || !method) {\n      return app.reg(method.at, method);\n    } else if (Api[method] && app) {\n      return result = Api[method].apply(app, Array.prototype.slice.call(_args, 1));\n    } else {\n      return $.error(\"Method \" + method + \" does not exist on jQuery.atwho\");\n    }\n  });\n  if (result != null) {\n    return result;\n  } else {\n    return this;\n  }\n};\n\n$.fn.atwho[\"default\"] = {\n  at: void 0,\n  alias: void 0,\n  data: null,\n  displayTpl: \"<li>${name}</li>\",\n  insertTpl: \"${atwho-at}${name}\",\n  headerTpl: null,\n  callbacks: DEFAULT_CALLBACKS,\n  functionOverrides: {},\n  searchKey: \"name\",\n  suffix: void 0,\n  hideWithoutSuffix: false,\n  startWithSpace: true,\n  acceptSpaceBar: false,\n  highlightFirst: true,\n  limit: 5,\n  maxLen: 20,\n  minLen: 0,\n  displayTimeout: 300,\n  delay: null,\n  spaceSelectsMatch: false,\n  tabSelectsMatch: true,\n  editableAtwhoQueryAttrs: {},\n  scrollDuration: 150,\n  suspendOnComposing: true,\n  lookUpOnClick: true\n};\n\n$.fn.atwho.debug = false;\n\n});\n"]}